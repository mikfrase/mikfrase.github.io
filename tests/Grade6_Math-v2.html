<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Knights of Columbus – 2026 Knowledge Contest – Math Grade 6 (Auto-Scored)</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --kc-red:#b5121b;
      --kc-blue:#003a70;
      --ok:#e7f8ef;
      --bad:#fde8e8;
      --border:#e5e7eb;
      --shadow:0 8px 24px rgba(0,0,0,.08);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background:var(--bg);
      color:var(--ink);
      line-height:1.35;
    }
    .wrap{max-width:980px;margin:24px auto;padding:0 14px}
    header{
      background:linear-gradient(135deg,var(--kc-blue),#0b5aa1);
      color:white;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px 18px 16px;
    }
    .title{display:flex;flex-wrap:wrap;gap:10px;align-items:baseline;justify-content:space-between}
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .badge{background:rgba(255,255,255,.16);border:1px solid rgba(255,255,255,.22);padding:6px 10px;border-radius:999px;font-size:12px}
    .sub{margin:8px 0 0;font-size:13px;color:rgba(255,255,255,.92)}
    .card{background:var(--card);margin:14px 0;border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 6px 18px rgba(0,0,0,.06);padding:16px;}
    .instructions{display:grid;gap:8px;font-size:14px;color:var(--ink);}
    .instructions ul{margin:6px 0 0 18px}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-top:12px}
    label{font-weight:600}
    input[type="text"]{width:min(420px,100%);padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;outline:none;}
    input[type="text"]:focus{border-color:#93c5fd; box-shadow:0 0 0 3px rgba(147,197,253,.35)}
    .section-title{margin:0 0 10px;font-size:16px;color:var(--kc-blue);display:flex;align-items:center;gap:10px}
    .section-title .pill{font-size:12px;background:#eef2ff;border:1px solid #dbeafe;padding:4px 10px;border-radius:999px;color:#1e40af}
    .q{border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 0;background:#fff;}
    .q.correct{background:var(--ok); border-color:#a7f3d0}
    .q.incorrect{background:var(--bad); border-color:#fecaca}
    .qhead{display:flex;gap:10px;align-items:flex-start}
    .qnum{min-width:34px;height:34px;border-radius:10px;display:grid;place-items:center;background:#f3f4f6;border:1px solid var(--border);font-weight:700;}
    .qtext{flex:1}
    .choices{margin-top:10px;display:grid;gap:8px}
    .choice{display:flex;gap:10px;align-items:flex-start;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fbfbfc;}
    .choice input{margin-top:3px}
    .sa{margin-top:10px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .sa input[type="text"]{width:min(320px,100%)}
    .actions{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    button{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;font-size:14px;}
    .primary{background:var(--kc-red);color:white}
    .primary:hover{filter:brightness(.95)}
    .ghost{background:#f3f4f6;color:#111827;border:1px solid var(--border)}
    .ghost:hover{background:#eef2f7}
    .note{color:var(--muted);font-size:12px}
    .results{border:1px solid var(--border);border-radius:14px;padding:14px;background:#f8fafc;display:none;}
    .results h2{margin:0 0 8px;font-size:16px;color:#111827}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:10px}
    .stat{background:white;border:1px solid var(--border);border-radius:12px;padding:10px;}
    .stat .k{font-size:12px;color:var(--muted)}
    .stat .v{font-size:18px;font-weight:800;margin-top:2px}
    .print-hint{margin-top:10px}
    .answer-key{margin-top:10px;display:none;font-size:13px;color:#111827;}
    .answer-key .tag{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#ffffff;font-weight:700;margin-right:8px;}
    .answer-key .val{color:#111827;font-weight:700;}
    .answer-key .muted{color:var(--muted);font-weight:600;}
    @media print{
      body{background:white}
      header{box-shadow:none}
      .card{box-shadow:none}
      button,.note{display:none!important}
      .results{display:block!important}
      .answer-key{display:none!important}
    }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>Knights of Columbus – 2026 Knowledge Contest – Mathematics (Grade 6)</h1>
      <div class="badge">Online • Auto-Scored • Printable</div>
    </div>
    <div class="sub">
      Multiple Choice 1–30 (1 point each) • Short Answer 31–40 (2 points each)
    </div>
  </header>

  <div class="card">
    <div class="instructions">
      <div><strong>Instructions</strong></div>
      <ul>
        <li><strong>Time:</strong> 30 minutes. Answer as many of the 40 questions as you can.</li>
        <li><strong>Tools:</strong> Use pencil and scratch paper. No calculators, smartphones, or smart watches.</li>
        <li><strong>Remember:</strong> This is a contest—do your best!</li>
      </ul>

      <div class="row">
        <label for="studentName">Student Name <span style="color:#b5121b">*</span>:</label>
        <input id="studentName" type="text" placeholder="Type your name here…" autocomplete="name" />
      </div>
      <div class="note">After scoring, a CSV download will automatically save your answers and score.</div>
    </div>
  </div>

  <form id="testForm" class="card" onsubmit="return false;">
    <div class="section-title">
      Multiple Choice <span class="pill">Questions 1–30</span>
    </div>
    <div id="mc"></div>

    <div class="section-title" style="margin-top:18px;">
      Short Answer <span class="pill">Questions 31–40</span>
    </div>
    <div id="sa"></div>

    <div class="actions" style="margin-top:16px;">
      <button class="primary" id="scoreBtn" type="button">Submit &amp; Score</button>
      <button class="ghost" id="resetBtn" type="button">Reset (Teacher)</button>
      <button class="ghost" id="revealBtn" type="button">Reveal Answers (Teacher)</button>
      <span class="note">Only answered questions are highlighted ✅/❌ after scoring.</span>
    </div>

    <div class="results" id="resultsBox" aria-live="polite">
      <h2 id="resultsTitle">Results</h2>
      <div class="grid">
        <div class="stat"><div class="k">Student</div><div class="v" id="rName">—</div></div>
        <div class="stat"><div class="k">Total Score</div><div class="v" id="rTotal">—</div></div>
        <div class="stat"><div class="k">Percent</div><div class="v" id="rPct">—</div></div>
        <div class="stat"><div class="k">MC (1–30)</div><div class="v" id="rMC">—</div></div>
        <div class="stat"><div class="k">Short Answer (31–40)</div><div class="v" id="rSA">—</div></div>
      </div>
      <div class="print-hint note">Printing tip: Use your browser’s Print command. This page is print-friendly.</div>
    </div>
  </form>
</div>

<script>
const TEACHER_CODE = "KOC2026";
let hasSubmitted = false;



function lockAllInputs(){
  // Lock student name + all answers after submission
  const name = document.getElementById("studentName");
  if (name) name.disabled = true;
  document.querySelectorAll("#testForm input").forEach(el=>{ el.disabled = true; });
}

function unlockAllInputs(){
  // Unlock student name + all answers (teacher reset)
  const name = document.getElementById("studentName");
  if (name) name.disabled = false;
  document.querySelectorAll("#testForm input").forEach(el=>{ el.disabled = false; });
}

const MC_QUESTIONS = [
  {n:1,  t:"4962 × 45 = ?", a:["44,658","223,290","222,280","189,310"]},
  {n:2,  t:"2 ÷ 3/8 = ?", a:["3/4","5 1/3","1 5/8","6"]},
  {n:3,  t:"37,945 ÷ 72 = ?", a:["624 R 17","520 R 55","527 R 1","527 R 11"]},
  {n:4,  t:"The 9 in 42,981,643,757 represents:", a:["9 million","9 ten-millions","9 hundred millions","not given"]},
  {n:5,  t:"60504 − 29615 = ?", a:["31,889","30,899","30,999","not given"]},
  {n:6,  t:"38 quarts = ? gallons", a:["9 1/2","4 3/4","19","not given"]},
  {n:7,  t:"Express the sum in lowest terms. 3 1/8 + 14 1/2 + 27 3/4 = ?", a:["44 11/8","44 3/8","45 3/8","not given"]},
  {n:8,  t:"The numeral for 6 million, five hundred ninety-two is:", a:["60,000,592","6,000,592","600,592","not given"]},
  {n:9,  t:"12 hours 30 minutes − 6 hours 55 minutes = ?", a:["5 hr 35 min","5 hr 45 min","6 hr 35 min","not given"]},
  {n:10, t:"A minivan weighs 5500 pounds which = ? tons.", a:["5 1/3","5 1/4","5 1/5","not given"]},
  {n:11, t:"Express the difference in lowest terms. 57 5/22 − 38 9/11 = ?", a:["18 9/22","19 9/22","18 19/22","not given"]},
  {n:12, t:"The numeral for four thousand, six hundred twelve and twelve hundredths is:", a:["46.1212","4612.12","4612.012","not given"]},
  {n:13, t:"2 1/3 × 6/7 = ?", a:["2","2 7/18","2 2/7","2 7/10"]},
  {n:14, t:"5 yards + 2 feet + 8 inches = ? inches", a:["221","212","202","not given"]},
  {n:15, t:"7,486 + 1249 = ?", a:["8635","8735","8625","not given"]},
  {n:16, t:"The metric prefix for 1,000,000 is ?", a:["mega-","milli-","kilo-","not given"]},
  {n:17, t:"A meter is ? one yard.", a:["less than","greater than","equal to","not given"]},
  {n:18, t:"8.3 + 79.74 + 59.003 = ?", a:["147.043","103.060","14,704.3","not given"]},
  {n:19, t:"Solve for n. 9/12 = n/16", a:["16","12","9","not given"]},
  {n:20, t:"352.673 − 163.785 = ?", a:["198.898","189.988","188.888","not given"]},
  {n:21, t:"Mary spelled 20 of 25 words correctly. What was her score on the test?", a:["80%","40%","50%","not given"]},
  {n:22, t:"7.38 × 0.32 = ?", a:["236.16","2361.6","23.616","not given"]},
  {n:23, t:"Which of these polygons is a quadrilateral?", a:["rectangle","parallelogram","square","A, B, and C"]},
  {n:24, t:"0.063 ÷ 21 = ?", a:["0.03","0.003","0.3","not given"]},
  {n:25, t:"The perimeter of a circle is its", a:["circumference","radius","diameter","not given"]},
  {n:26, t:"Round 9.515 to the nearest hundredth.", a:["9.5","10.0","9.52","not given"]},
  {n:27, t:"25 liters = ? milliliters", a:["2500","25,000","250","not given"]},
  {n:28, t:"Which numeral is equivalent to 1/4?", a:["7/28","0.25","A and B","not given"]},
  {n:29, t:"In Europe distances between cities are measured in ?", a:["meters","kilometers","centimeters","not given"]},
  {n:30, t:"Which ratio is expressed in lowest terms?", a:["14/21","3/24","15/20","not given"]}
];
const MC_KEY = {
  1:"B",2:"B",3:"C",4:"C",5:"D",6:"A",7:"C",8:"B",9:"A",10:"D",
  11:"A",12:"B",13:"A",14:"B",15:"B",16:"A",17:"B",18:"A",19:"B",20:"C",
  21:"A",22:"D",23:"D",24:"B",25:"A",26:"C",27:"B",28:"C",29:"B",30:"D"
};
const SA_QUESTIONS = [
  {n:31, t:"TARGET advertised a 20% off sale. What would the discount price be on a jacket that originally sold for $79.99?"},
  {n:32, t:"The Earth is about 93,000,000 miles from the sun. Jupiter is 483,000,000 miles from the sun. How far beyond the Earth is Jupiter?"},
  {n:33, t:"A fish tank measures 55 cm × 35 cm × 45 cm. What is the volume of this tank?"},
  {n:34, t:"A sho is a Japanese unit of liquid measure equal to 1.91 quarts. Eight sho would equal ? quarts."},
  {n:35, t:"A rectangular gerbil cage has a volume of 960 cubic inches with a length of 12 inches and a width of 8 inches. What is the height of the cage in inches?"},
  {n:36, t:"Mr. Nelson used 6.5 gallons of gas to drive 98.8 miles. What was the average number of miles per gallon? (Round to the nearest mile.)"},
  {n:37, t:"A liter of fluorine has a mass of 1.695 grams. The mass of a liter of oxygen is 1.428 grams. What is the total mass of 5 liters of fluorine and 10 liters of oxygen?"},
  {n:38, t:"A high school girls’ softball team won 18 games and lost 7. What percent of their games did they win?"},
  {n:39, t:"Last summer the temperature in Rome reached 30° C or ? °F.  F = 9/5 C + 32"},
  {n:40, t:"Calculate the volume in cubic feet of a rectangular solid that is 4 yards by 7 1/2 feet by 36 inches."}
];
const SA_ACCEPT = {
  31: ["$63.99","63.99","63.99 dollars","63.99$"],
  32: ["390000000 mi","390,000,000 mi","390000000 miles","390,000,000 miles","390000000"],
  33: ["86625 cm3","86,625 cm3","86625 cubic centimeters","86625 cu cm","86,625 cu cm","86625"],
  34: ["15.28 qt","15.28 quarts","15.28"],
  35: ["10 in","10 inches","10"],
  36: ["15 mi","15 miles","15 mpg","15"],
  37: ["22.755 g","22.755 grams","22.755"],
  38: ["72%","72 percent","72"],
  39: ["86 f","86°f","86 f.","86 degrees f","86 degrees fahrenheit","86"],
  40: ["270 ft3","270 cu ft","270 cubic feet","270","270 ft^3","270 cuft"]
};

function csvEscape(value){
  const s = (value === null || value === undefined) ? "" : String(value);
  if (s.includes(",") || s.includes('"') || s.includes("\n")) {
    return '"' + s.replace(/"/g,'""') + '"';
  }
  return s;
}

function formatLocalTimestamp(){
  const d = new Date();
  const pad = (n)=> String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

function buildResultsCSV(payload){
  const header = ["Student Name","Timestamp","Total Score","Max Score","Percent","MC Score","MC Max","Short Answer Score","Short Answer Max"];
  const summary = [payload.studentName,payload.timestamp,payload.total,payload.maxScore,payload.pct,payload.mcPts,payload.maxMc,payload.saPts,payload.maxSa];
  const lines = [];
  lines.push(header.map(csvEscape).join(","));
  lines.push(summary.map(csvEscape).join(","));
  lines.push("");
  lines.push(["Question","Type","Prompt","Student Answer","Correct Answer","Points Earned","Max Points","Correct?"].map(csvEscape).join(","));
  for (const r of payload.rows){
    lines.push([r.q,r.type,r.prompt,r.student,r.correctAnswer,r.points,r.maxPoints,r.isCorrect?"YES":"NO"].map(csvEscape).join(","));
  }
  return lines.join("\n");
}

function downloadCSV(filename, csvText){
  const blob = new Blob([csvText], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

/* Parse a numeric value from a student response, ignoring letters/units.
   Supports integers, decimals, fractions, and mixed numbers like 7 1/2.
*/
function parseNumericValue(input){
  if (input == null) return NaN;
  let s = String(input).toLowerCase();
  s = s.replace(/[^0-9\-\.\/\s]/g, " ");
  s = s.replace(/\s+/g, " ").trim();
  if (!s) return NaN;

  // Mixed number "25 1/2"
  let m = s.match(/^(-?\d+)\s+(\d+)\s*\/\s*(\d+)$/);
  if (m){
    const whole = parseInt(m[1],10);
    const num = parseInt(m[2],10);
    const den = parseInt(m[3],10);
    if (den === 0) return NaN;
    const sign = whole < 0 ? -1 : 1;
    return whole + sign*(num/den);
  }

  // Fraction "1/2"
  m = s.match(/^(-?\d+)\s*\/\s*(\d+)$/);
  if (m){
    const num = parseInt(m[1],10);
    const den = parseInt(m[2],10);
    if (den === 0) return NaN;
    return num/den;
  }

  // Decimal/integer
  m = s.match(/-?\d+(?:\.\d+)?/);
  if (m) return parseFloat(m[0]);
  return NaN;
}

function nearlyEqual(a,b){
  if (!isFinite(a) || !isFinite(b)) return false;
  return Math.abs(a-b) <= 1e-9;
}

function el(tag, attrs={}, children=[]){
  const e = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)){
    if (k === "class") e.className = v;
    else if (k === "html") e.innerHTML = v;
    else e.setAttribute(k, v);
  }
  for (const c of children){
    if (typeof c === "string") e.appendChild(document.createTextNode(c));
    else e.appendChild(c);
  }
  return e;
}

function render(){
  const mc = document.getElementById("mc");
  MC_QUESTIONS.forEach(q=>{
    const box = el("div",{class:"q", id:`q${q.n}`},[
      el("div",{class:"qhead"},[
        el("div",{class:"qnum"},[String(q.n)]),
        el("div",{class:"qtext"},[ el("div",{html:`<strong>${q.t}</strong>`}) ])
      ])
    ]);

    const choices = el("div",{class:"choices"});
    const letters = ["A","B","C","D"];
    q.a.forEach((txt,i)=>{
      const id = `q${q.n}_${letters[i]}`;
      const choice = el("label",{class:"choice", for:id},[
        el("input",{type:"radio", name:`q${q.n}`, id, value:letters[i]}),
        el("span",{html:`<strong>${letters[i]}.</strong> ${txt}`})
      ]);
      choices.appendChild(choice);
    });
    box.appendChild(choices);

    const ak = el("div",{class:"answer-key", id:`ak${q.n}`},[
      el("span",{class:"tag"},["Answer"]),
      el("span",{class:"val", id:`akv${q.n}`},["—"]),
      el("span",{class:"muted"},["(teacher)"])
    ]);
    box.appendChild(ak);

    mc.appendChild(box);
  });

  const sa = document.getElementById("sa");
  SA_QUESTIONS.forEach(q=>{
    const box = el("div",{class:"q", id:`q${q.n}`},[
      el("div",{class:"qhead"},[
        el("div",{class:"qnum"},[String(q.n)]),
        el("div",{class:"qtext"},[ el("div",{html:`<strong>${q.t}</strong>`}) ])
      ]),
      el("div",{class:"sa"},[
        el("label",{for:`sa${q.n}`},["Answer:"]),
        el("input",{type:"text", id:`sa${q.n}`, placeholder:"Type your answer (numbers only; units OK)…"})
      ])
    ]);

    const ak = el("div",{class:"answer-key", id:`ak${q.n}`},[
      el("span",{class:"tag"},["Answer"]),
      el("span",{class:"val", id:`akv${q.n}`},["—"]),
      el("span",{class:"muted"},["(teacher)"])
    ]);
    box.appendChild(ak);

    sa.appendChild(box);
  });
}

function clearHighlights(){
  document.querySelectorAll(".q.correct,.q.incorrect").forEach(d=>{
    d.classList.remove("correct","incorrect");
  });
}

function markQuestion(n, status){
  const box = document.getElementById(`q${n}`);
  if (!box) return;
  box.classList.remove("correct","incorrect");
  if (status === "correct") box.classList.add("correct");
  if (status === "incorrect") box.classList.add("incorrect");
}

function getMcAnswer(n){
  const checked = document.querySelector(`input[name="q${n}"]:checked`);
  return checked ? checked.value : "";
}
function getSaAnswer(n){
  const inp = document.getElementById(`sa${n}`);
  return inp ? inp.value : "";
}

let answersRevealed = false;

function showAnswerKeys(){
  for (let n=1; n<=30; n++) {
    const v = document.getElementById(`akv${n}`);
    const c = document.getElementById(`ak${n}`);
    if (v) v.textContent = MC_KEY[n] || "—";
    if (c) c.style.display = "block";
  }
  for (let n=31; n<=40; n++) {
    const v = document.getElementById(`akv${n}`);
    const c = document.getElementById(`ak${n}`);
    if (v) {
      let correctVal = "—";
      const accList = SA_ACCEPT[n] || [];
      for (const item of accList) {
        const num = parseNumericValue(item);
        if (isFinite(num)) { correctVal = Number.isInteger(num) ? String(num) : String(num); break; }
      }
      v.textContent = correctVal;
    }
    if (c) c.style.display = "block";
  }
}

function hideAnswerKeys(){
  for (let n=1; n<=40; n++) {
    const c = document.getElementById(`ak${n}`);
    if (c) c.style.display = "none";
  }
}

function toggleRevealAnswers(){
  const code = prompt("Teacher code required to reveal/hide the answer key:");
  if (code === null) return;
  if (code !== TEACHER_CODE) {
    alert("Incorrect teacher code. Answer key was not changed.");
    return;
  }
  answersRevealed = !answersRevealed;
  const btn = document.getElementById("revealBtn");
  if (answersRevealed) {
    showAnswerKeys();
    if (btn) btn.textContent = "Hide Answers (Teacher)";
  } else {
    hideAnswerKeys();
    if (btn) btn.textContent = "Reveal Answers (Teacher)";
  }
}

function score(){
  const nameInput = document.getElementById("studentName");
  const name = (nameInput ? nameInput.value.trim() : "");
  // Validate required name BEFORE locking submission
  if (!name){
    alert("Please enter your Student Name before submitting.");
    if (nameInput) nameInput.focus();
    return;
  }
  if (hasSubmitted) return;
  const ok = confirm("Submit now? You can only submit once.");
  if (!ok) return;
  hasSubmitted = true;
  const sb = document.getElementById("scoreBtn");
  if (sb) { sb.disabled = true; sb.textContent = "Submitted"; }
  lockAllInputs();
clearHighlights();

  let mcPts=0, saPts=0;

  for (let n=1;n<=30;n++){ 
    const ans = getMcAnswer(n);
    if (!ans) continue;
    if (ans === MC_KEY[n]){ mcPts += 1; markQuestion(n,"correct"); }
    else markQuestion(n,"incorrect");
  }

  for (let n=31;n<=40;n++){
    const raw = getSaAnswer(n);
    if (!raw.trim()) continue;

    const userVal = parseNumericValue(raw);
    const accList = SA_ACCEPT[n] || [];
    let correctVal = NaN;
    for (const item of accList) {
      const v = parseNumericValue(item);
      if (isFinite(v)) { correctVal = v; break; }
    }

    if (isFinite(userVal) && isFinite(correctVal) && nearlyEqual(userVal, correctVal)) {
      saPts += 2;
      markQuestion(n,"correct");
    } else {
      markQuestion(n,"incorrect");
    }
  }

  const total = mcPts + saPts;
  const pct = Math.round((total/50)*1000)/10;

  document.getElementById("resultsBox").style.display="block";
  document.getElementById("rName").textContent = name;
  document.getElementById("rTotal").textContent = `${total} / 50`;
  document.getElementById("rPct").textContent = `${pct}%`;
  document.getElementById("rMC").textContent = `${mcPts} / 30`;
  document.getElementById("rSA").textContent = `${saPts} / 20`;
  document.getElementById("resultsTitle").textContent = "Results (Grade 6)";

  // CSV export
  const timestamp = formatLocalTimestamp();
  const rows = [];

  for (let n=1; n<=30; n++){
    const q = MC_QUESTIONS.find(x=>x.n===n) || {};
    const student = getMcAnswer(n);
    const correct = MC_KEY[n] || "";
    const isCorrect = !!student && student === correct;
    rows.push({ q:n, type:"MC", prompt:q.t||"", student:student||"", correctAnswer:correct, points:isCorrect?1:0, maxPoints:1, isCorrect });
  }

  for (let n=31; n<=40; n++){
    const q = SA_QUESTIONS.find(x=>x.n===n) || {};
    const studentRaw = getSaAnswer(n);
    const userVal = parseNumericValue(studentRaw);
    const accList = SA_ACCEPT[n] || [];
    let correctVal = NaN;
    for (const item of accList) {
      const v = parseNumericValue(item);
      if (isFinite(v)) { correctVal = v; break; }
    }
    const isCorrect = (studentRaw.trim() !== "") && isFinite(userVal) && isFinite(correctVal) && nearlyEqual(userVal, correctVal);
    rows.push({
      q:n, type:"SA", prompt:q.t||"", student:studentRaw||"",
      correctAnswer: (isFinite(correctVal) ? (Number.isInteger(correctVal)?String(correctVal):String(correctVal)) : ""),
      points:isCorrect?2:0, maxPoints:2, isCorrect
    });
  }

  const payload = {
    studentName:name, timestamp, mcPts, saPts, total,
    pct: pct + "%", maxScore:50, maxMc:30, maxSa:20, rows
  };
  const csvText = buildResultsCSV(payload);
  const safeName = name.replace(/[^a-z0-9]+/gi,"_").replace(/^_+|_+$/g,"");
  const filename = `KofC_Grade6_${safeName || "Student"}_${timestamp.replace(/[: ]/g,"-")}.csv`;
  downloadCSV(filename, csvText);

  document.getElementById("resultsBox").scrollIntoView({behavior:"smooth", block:"start"});
}

function teacherReset(){
  const code = prompt("Teacher reset code required to clear all answers/results:");
  if (code === null) return;
  if (code !== TEACHER_CODE){
    alert("Incorrect reset code. Answers were not cleared.");
    return;
  }
  if (!confirm("Clear all answers and results?")) return;
  document.getElementById("testForm").reset();
  // Student name is outside the form, so clear it explicitly
  const nameInput = document.getElementById("studentName");
  if (nameInput) nameInput.value = "";
  document.getElementById("resultsBox").style.display="none";
  clearHighlights();
  hasSubmitted = false;
  // Re-enable inputs and submit button
  unlockAllInputs();
  const sb = document.getElementById("scoreBtn");
  if (sb){ sb.disabled = false; sb.textContent = "Submit & Score"; }
  if (answersRevealed) showAnswerKeys();
}

const scoreBtn = document.getElementById("scoreBtn");
if (scoreBtn) scoreBtn.addEventListener("click", score);
const resetBtn = document.getElementById("resetBtn");
if (resetBtn) resetBtn.addEventListener("click", teacherReset);
const revealBtn = document.getElementById("revealBtn");
if (revealBtn) revealBtn.addEventListener("click", toggleRevealAnswers);

render();
</script>
</body>
</html>
