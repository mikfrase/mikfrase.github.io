<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Knights of Columbus – 2026 Knowledge Contest – Math Grade 8 (Auto-Scored)</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --ink:#1f2937; --muted:#6b7280;
      --kc-red:#b5121b; --kc-blue:#003a70;
      --ok:#e7f8ef; --bad:#fde8e8; --border:#e5e7eb;
      --shadow:0 8px 24px rgba(0,0,0,.08); --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";background:var(--bg);color:var(--ink);line-height:1.35;}
    .wrap{max-width:980px;margin:24px auto;padding:0 14px}
    header{background:linear-gradient(135deg,var(--kc-blue),#0b5aa1);color:white;border-radius:var(--radius);box-shadow:var(--shadow);padding:18px 18px 16px;}
    .title{display:flex;flex-wrap:wrap;gap:10px;align-items:baseline;justify-content:space-between}
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .badge{background:rgba(255,255,255,.16);border:1px solid rgba(255,255,255,.22);padding:6px 10px;border-radius:999px;font-size:12px}
    .sub{margin:8px 0 0;font-size:13px;color:rgba(255,255,255,.92)}
    .card{background:var(--card);margin:14px 0;border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 6px 18px rgba(0,0,0,.06);padding:16px;}
    .instructions{display:grid;gap:8px;font-size:14px;}
    .instructions ul{margin:6px 0 0 18px}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-top:12px}
    label{font-weight:600}
    input[type="text"]{width:min(420px,100%);padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;outline:none;}
    input[type="text"]:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(147,197,253,.35)}
    .section-title{margin:0 0 10px;font-size:16px;color:var(--kc-blue);display:flex;align-items:center;gap:10px}
    .section-title .pill{font-size:12px;background:#eef2ff;border:1px solid #dbeafe;padding:4px 10px;border-radius:999px;color:#1e40af}
    .q{border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 0;background:#fff;}
    .q.correct{background:var(--ok); border-color:#a7f3d0}
    .q.incorrect{background:var(--bad); border-color:#fecaca}
    .qhead{display:flex;gap:10px;align-items:flex-start}
    .qnum{min-width:34px;height:34px;border-radius:10px;display:grid;place-items:center;background:#f3f4f6;border:1px solid var(--border);font-weight:700;}
    .qtext{flex:1}
    .choices{margin-top:10px;display:grid;gap:8px}
    .choice{display:flex;gap:10px;align-items:flex-start;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fbfbfc;}
    .choice input{margin-top:3px}
    .sa{margin-top:10px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .sa input[type="text"]{width:min(520px,100%)}
    .actions{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    button{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;font-size:14px;}
    .primary{background:var(--kc-red);color:white}
    .primary:hover{filter:brightness(.95)}
    .ghost{background:#f3f4f6;color:#111827;border:1px solid var(--border)}
    .ghost:hover{background:#eef2f7}
    .note{color:var(--muted);font-size:12px}
    .results{border:1px solid var(--border);border-radius:14px;padding:14px;background:#f8fafc;display:none;}
    .results h2{margin:0 0 8px;font-size:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:10px}
    .stat{background:white;border:1px solid var(--border);border-radius:12px;padding:10px;}
    .stat .k{font-size:12px;color:var(--muted)}
    .stat .v{font-size:18px;font-weight:800;margin-top:2px}
    .answer-key{margin-top:10px;display:none;font-size:13px;color:#111827;}
    .answer-key .tag{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#ffffff;font-weight:700;margin-right:8px;}
    .answer-key .val{color:#111827;font-weight:700;}
    .answer-key .muted{color:var(--muted);font-weight:600;}
    @media print{
      body{background:white}
      header{box-shadow:none}
      .card{box-shadow:none}
      button,.note{display:none!important}
      .results{display:block!important}
      .answer-key{display:none!important}
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>Knights of Columbus – 2026 Knowledge Contest – Mathematics (Grade 8)</h1>
      <div class="badge">Online • Auto-Scored • Printable</div>
    </div>
    <div class="sub">Multiple Choice 1–30 (1 point each) • Short Answer 31–40 (2 points each)</div>
  </header>

  <div class="card">
    <div class="instructions">
      <div><strong>Instructions</strong></div>
      <ul>
        <li><strong>Time:</strong> 30 minutes. Answer as many of the 40 questions as you can.</li>
        <li><strong>Tools:</strong> Use pencil and scratch paper. No calculators, smartphones, or smart watches.</li>
        <li><strong>Submit:</strong> Click <strong>Submit &amp; Score</strong> to score instantly and download a CSV of answers.</li>
      </ul>
      <div class="row">
        <label for="studentName">Student Name <span style="color:#b5121b">*</span>:</label>
        <input id="studentName" type="text" placeholder="Type your name here…" autocomplete="name" />
      </div>
      <div class="note">Short-answer grading checks only the numeric value (letters/units ignored). Teacher code for reset/reveal: <strong>KOC2026</strong>.</div>
    </div>
  </div>

  <form id="testForm" class="card" onsubmit="return false;">
    <div class="section-title">Multiple Choice <span class="pill">Questions 1–30</span></div>
    <div id="mc"></div>

    <div class="section-title" style="margin-top:18px;">Short Answer <span class="pill">Questions 31–40</span></div>
    <div id="sa"></div>

    <div class="actions" style="margin-top:16px;">
      <button class="primary" id="scoreBtn" type="button">Submit &amp; Score</button>
      <button class="ghost" id="resetBtn" type="button">Reset (Teacher)</button>
      <button class="ghost" id="revealBtn" type="button">Reveal Answers (Teacher)</button>
      <span class="note">Only answered questions are highlighted ✅/❌ after scoring.</span>
    </div>

    <div class="results" id="resultsBox" aria-live="polite">
      <h2 id="resultsTitle">Results</h2>
      <div class="grid">
        <div class="stat"><div class="k">Student</div><div class="v" id="rName">—</div></div>
        <div class="stat"><div class="k">Total Score</div><div class="v" id="rTotal">—</div></div>
        <div class="stat"><div class="k">Percent</div><div class="v" id="rPct">—</div></div>
        <div class="stat"><div class="k">MC (1–30)</div><div class="v" id="rMC">—</div></div>
        <div class="stat"><div class="k">Short Answer (31–40)</div><div class="v" id="rSA">—</div></div>
      </div>
      <div class="note" style="margin-top:10px;">Printing tip: Use your browser’s Print command. This page is print-friendly.</div>
    </div>
  </form>
</div>

<script>
const TEACHER_CODE = "KOC2026";
let hasSubmitted = false;



function lockAllInputs(){
  // Lock student name + all answer inputs after submission
  const name = document.getElementById("studentName");
  if (name) name.disabled = true;
  document.querySelectorAll("#testForm input").forEach(el=>{ el.disabled = true; });
}

function unlockAllInputs(){
  // Unlock student name + all answer inputs (teacher reset)
  const name = document.getElementById("studentName");
  if (name) name.disabled = false;
  document.querySelectorAll("#testForm input").forEach(el=>{ el.disabled = false; });
}

const MC_QUESTIONS = [
  {n:1, t:"673,158 ÷ 743 = __?__", a:["960","906","900 R 6","not given"]},
  {n:2, t:"13 4/5 + 8 ÷ 1 1/5 = __?__", a:["19 7/15","20 7/15","18 1/6","not given"]},
  {n:3, t:"Light travels 5,865,696,000,000 miles in one year. Which digit is in the hundred billions place?", a:["9","5","6","8"]},
  {n:4, t:"Which fraction is expressed in simplest form?", a:["6/27","18/32","3/21","not given"]},
  {n:5, t:"2 1/4 × 2 2/3 − 4 11/12 = __?__", a:["1 5/12","1 7/12","1 1/12","not given"]},
  {n:6, t:"Which numeral stands for 136 hundred-thousandths?", a:["100,036","0.00136","136,000","0.000136"]},
  {n:7, t:"0.097 × 0.209 = __?__", a:["0.020273","0.20273","20.273","not given"]},
  {n:8, t:"25.272 ÷ 5.4 = __?__", a:["46.8","0.468","4.68","not given"]},
  {n:9, t:"237,720 + 8314 + 34,205 + 699 = __?__", a:["270,928","281,828","280,938","not given"]},
  {n:10, t:"What is 1.35 written as a percent?", a:["1350%","1.35%","13.5%","not given"]},
  {n:11, t:"6 3/4 + 7 1/8 + 8 1/3 = __?__", a:["22 1/5","21 5/24","22 5/24","not given"]},
  {n:12, t:"687,004 − 591,903 = __?__", a:["95,011","96,021","96,121","not given"]},
  {n:13, t:"What is the reciprocal of 2 3/8?", a:["8/19","8/23","19/8","not given"]},
  {n:14, t:"What is the decimal equivalent of 5/8?", a:["62.5","0.625","6.25","not given"]},
  {n:15, t:"743 × 609 = __?__", a:["451,487","442,487","452,487","not given"]},
  {n:16, t:"What is the most sensible metric unit for the dimensions of a soccer field?", a:["cm","mm","km","not given"]},
  {n:17, t:"What is the greatest common factor of 48 and 60?", a:["6","4","8","not given"]},
  {n:18, t:"Solve for y: 0.5 y + 3.4 = 9.31", a:["23.64","5.91","11.82","not given"]},
  {n:19, t:"What is the prime factorization of 500?", a:["4 × 5^2","2^2 × 25^2","2^2 × 5^3","not given"]},
  {n:20, t:"Solve for x: 2x ( − 4) = − 6", a:["− 8","− 2","− 10","not given"]},
  {n:21, t:"12 1/2% of __?__ = 36", a:["28.8","288","2.88","not given"]},
  {n:22, t:"Which ordered pair fits the equation y = 4x + 2?", a:["(2, 10)","(2, 8)","(10, 2)","not given"]},
  {n:23, t:"5 gal 2 qt − 2 gal 3 qt 1 pt = __?__", a:["3 gal 1 pt","3 gal 1 qt","2 gal 2 qt 1 pt","not given"]},
  {n:24, t:"How many decades equal a millennium?", a:["100","1000","1,000,000","not given"]},
  {n:25, t:"4 hr 20 min − 2 hr 40 min 10 sec = __?__", a:["1 hr 40 min 50 sec","2 hr 40 min 50 sec","1 hr 39 min 50 sec","not given"]},
  {n:26, t:"The perimeter of a regular pentagon is 15 cm. What is the length of each side?", a:["45 cm","15 cm","25 cm","not given"]},
  {n:27, t:"Find the surface area of a 2.7 cm cube.", a:["43.74 cm²","7.29 cm²","29.16 cm²","not given"]},
  {n:28, t:"The area of a triangle with a 40 cm base is 400 cm². What is its height?", a:["25 cm","40 cm","20 cm","not given"]},
  {n:29, t:"What is the area of a circle with a circumference of 12.56 inches? (π = 3.14)", a:["12.56 in²","3.14 in²","50.24 in²","not given"]},
  {n:30, t:"This triangle has only 2 sides of equal length.", a:["equilateral","scalene","isosceles","not given"]}
];
const MC_KEY = {
  1:"B",
  2:"B",
  3:"D",
  4:"D",
  5:"C",
  6:"B",
  7:"A",
  8:"C",
  9:"C",
  10:"D",
  11:"C",
  12:"D",
  13:"A",
  14:"B",
  15:"C",
  16:"D",
  17:"D",
  18:"C",
  19:"C",
  20:"D",
  21:"B",
  22:"A",
  23:"C",
  24:"A",
  25:"C",
  26:"D",
  27:"A",
  28:"C",
  29:"A",
  30:"C"
};
const SA_QUESTIONS = [
  {n:31, t:"Alpha Centauri, the second closest star (sun) to our Earth, is 4.3 light years away. A light-year equals 5.8 trillion miles. Find the distance from Earth to Alpha Centauri in miles. (Express your answer in scientific notation)"},
  {n:32, t:"A rectangular prism is 8 ft long, 4 ft wide and 12 ft high. Find its total surface area."},
  {n:33, t:"An aquarium measures 24 in × 8 in × 12 in. Calculate the number of gallons of water needed to fill it. Round your answer to the nearest tenth of a gallon. (One gallon equals 231 cu in.)"},
  {n:34, t:"The official high temperatures for the week were: 62°, 65°, 56°, 59°, 64°, 62°, and 86°. Calculate the average high temperature to the nearest Fahrenheit degree."},
  {n:35, t:"The Howe family used 721 kilowatt hours of electrical energy last month. The power company charged $0.0732 per kwh and included a monthly facilities charge of $5.85. A 5.6% sales tax must be included on the total bill. Calculate the Howe’s electric bill to the nearest $0.01."},
  {n:36, t:"A room is 12 ft wide and 21 ft long. At $19.95 a square yard, how much would it cost to buy wall-to-wall carpeting for this room?"},
  {n:37, t:"How much greater is the capacity of a 7-inch cube compared to a sphere with a 7 inch diameter? (π = 22/7; V = 4/3 π r³) Round your answer to the nearest cubic inch."},
  {n:38, t:"Convert 37° C to F.  F = 9/5C + 32"},
  {n:39, t:"Find the volume of an irregularly shaped rock which, when submerged in a cylinder having an inside diameter of 10 in, causes the water in the cylinder to rise 3 in. (π = 3.14; round your answer to the nearest cubic inch.)"},
  {n:40, t:"Mr. Timm took out a loan. After 3 months he owed $30.00 in interest. The simple interest rate was 6%. How much did he borrow?"}
];
const SA_ACCEPT = {
  31: ["2.494 × 10^13", "2.494x10^13", "2.494e13", "2.494E13", "2.494×10^13"],
  32: ["352", "352 ft2", "352 sq ft", "352 ft²"],
  33: ["10", "10 gal", "10.0", "10.0 gal"],
  34: ["65", "65 F", "65°F"],
  35: ["61.91", "$61.91", "61.910"],
  36: ["558.60", "$558.60", "558.6"],
  37: ["163", "163 in3", "163 cu in", "163 in³"],
  38: ["98.6", "98.6 F", "98.6°F"],
  39: ["236", "236 in3", "236 cu in", "236 in³"],
  40: ["2000", "$2000.00", "2000.00", "$2000"]
};

function csvEscape(value){
  const s = (value === null || value === undefined) ? "" : String(value);
  if (s.includes(",") || s.includes('"') || s.includes("\n")) return '"' + s.replace(/"/g,'""') + '"';
  return s;
}
function formatLocalTimestamp(){
  const d = new Date();
  const pad = (n)=> String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function buildResultsCSV(payload){
  const header = ["Student Name","Timestamp","Total Score","Max Score","Percent","MC Score","MC Max","Short Answer Score","Short Answer Max"];
  const summary = [payload.studentName,payload.timestamp,payload.total,payload.maxScore,payload.pct,payload.mcPts,payload.maxMc,payload.saPts,payload.maxSa];
  const lines = [];
  lines.push(header.map(csvEscape).join(","));
  lines.push(summary.map(csvEscape).join(","));
  lines.push("");
  lines.push(["Question","Type","Prompt","Student Answer","Correct Answer","Points Earned","Max Points","Correct?"].map(csvEscape).join(","));
  for (const r of payload.rows){
    lines.push([r.q,r.type,r.prompt,r.student,r.correctAnswer,r.points,r.maxPoints,r.isCorrect?"YES":"NO"].map(csvEscape).join(","));
  }
  return lines.join("\n");
}
function downloadCSV(filename, csvText){
  const blob = new Blob([csvText], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

/* Parse numeric value from response, ignoring letters/units.
   Supports integers, decimals, fractions, mixed numbers, and basic scientific notation forms.
*/
function parseNumericValue(input){
  if (input == null) return NaN;
  let s = String(input).toLowerCase();

  // normalize multiplication symbols
  s = s.replace(/×/g, "x");

  // Handle scientific notation like "2.494 x 10^13"
  let sci = s.match(/(-?\d+(?:\.\d+)?)\s*x\s*10\s*\^\s*(-?\d+)/);
  if (sci) {
    const base = parseFloat(sci[1]);
    const exp = parseInt(sci[2], 10);
    if (isFinite(base) && isFinite(exp)) return base * Math.pow(10, exp);
  }

  // Handle e-notation like 2.494e13 (allow spaces)
  let en = s.match(/-?\d+(?:\.\d+)?\s*[e]\s*-?\d+/);
  if (en) return parseFloat(en[0].replace(/\s+/g,""));

  // strip non-numeric (keep digits, -, ., / and spaces)
  s = s.replace(/[^0-9\-\.\/\s]/g, " ");
  s = s.replace(/\s+/g, " ").trim();
  if (!s) return NaN;

  // Mixed number "25 1/2"
  let m = s.match(/^(-?\d+)\s+(\d+)\s*\/\s*(\d+)$/);
  if (m){
    const whole = parseInt(m[1],10), num = parseInt(m[2],10), den = parseInt(m[3],10);
    if (den === 0) return NaN;
    const sign = whole < 0 ? -1 : 1;
    return whole + sign*(num/den);
  }

  // Fraction "1/2"
  m = s.match(/^(-?\d+)\s*\/\s*(\d+)$/);
  if (m){
    const num = parseInt(m[1],10), den = parseInt(m[2],10);
    if (den === 0) return NaN;
    return num/den;
  }

  // Decimal/integer
  m = s.match(/-?\d+(?:\.\d+)?/);
  if (m) return parseFloat(m[0]);
  return NaN;
}
function nearlyEqual(a,b){ return isFinite(a) && isFinite(b) && Math.abs(a-b) <= 1e-6; }

function el(tag, attrs={}, children=[]){
  const e = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)){
    if (k === "class") e.className = v;
    else if (k === "html") e.innerHTML = v;
    else e.setAttribute(k, v);
  }
  for (const c of children){
    if (typeof c === "string") e.appendChild(document.createTextNode(c));
    else e.appendChild(c);
  }
  return e;
}

function render(){
  const mc = document.getElementById("mc");
  MC_QUESTIONS.forEach(q=>{
    const box = el("div",{class:"q", id:`q${q.n}`},[
      el("div",{class:"qhead"},[
        el("div",{class:"qnum"},[String(q.n)]),
        el("div",{class:"qtext"},[ el("div",{html:`<strong>${q.t}</strong>`}) ])
      ])
    ]);
    const choices = el("div",{class:"choices"});
    const letters = ["A","B","C","D"];
    q.a.forEach((txt,i)=>{
      const id = `q${q.n}_${letters[i]}`;
      choices.appendChild(el("label",{class:"choice", for:id},[
        el("input",{type:"radio", name:`q${q.n}`, id, value:letters[i]}),
        el("span",{html:`<strong>${letters[i]}.</strong> ${txt}`})
      ]));
    });
    box.appendChild(choices);
    box.appendChild(el("div",{class:"answer-key", id:`ak${q.n}`},[
      el("span",{class:"tag"},["Answer"]),
      el("span",{class:"val", id:`akv${q.n}`},["—"]),
      el("span",{class:"muted"},["(teacher)"])
    ]));
    mc.appendChild(box);
  });

  const sa = document.getElementById("sa");
  SA_QUESTIONS.forEach(q=>{
    const box = el("div",{class:"q", id:`q${q.n}`},[
      el("div",{class:"qhead"},[
        el("div",{class:"qnum"},[String(q.n)]),
        el("div",{class:"qtext"},[ el("div",{html:`<strong>${q.t}</strong>`}) ])
      ]),
      el("div",{class:"sa"},[
        el("label",{for:`sa${q.n}`},["Answer:"]),
        el("input",{type:"text", id:`sa${q.n}`, placeholder:"Type your answer (numbers only; units OK)…"})
      ])
    ]);
    box.appendChild(el("div",{class:"answer-key", id:`ak${q.n}`},[
      el("span",{class:"tag"},["Answer"]),
      el("span",{class:"val", id:`akv${q.n}`},["—"]),
      el("span",{class:"muted"},["(teacher)"])
    ]));
    sa.appendChild(box);
  });
}

function clearHighlights(){ document.querySelectorAll(".q.correct,.q.incorrect").forEach(d=>d.classList.remove("correct","incorrect")); }
function markQuestion(n, status){
  const box = document.getElementById(`q${n}`);
  if (!box) return;
  box.classList.remove("correct","incorrect");
  if (status === "correct") box.classList.add("correct");
  if (status === "incorrect") box.classList.add("incorrect");
}
function getMcAnswer(n){ const c=document.querySelector(`input[name="q${n}"]:checked`); return c?c.value:""; }
function getSaAnswer(n){ const i=document.getElementById(`sa${n}`); return i?i.value:""; }

let answersRevealed = false;
function showAnswerKeys(){
  for (let n=1; n<=30; n++){ 
    const v=document.getElementById(`akv${n}`), c=document.getElementById(`ak${n}`);
    if (v) v.textContent = MC_KEY[n] || "—";
    if (c) c.style.display="block";
  }
  for (let n=31; n<=40; n++){ 
    const v=document.getElementById(`akv${n}`), c=document.getElementById(`ak${n}`);
    if (v){ 
      const accList = SA_ACCEPT[n] || [];
      v.textContent = accList.length ? accList[0] : "—";
    }
    if (c) c.style.display="block";
  }
}
function hideAnswerKeys(){ for (let n=1;n<=40;n++){ const c=document.getElementById(`ak${n}`); if (c) c.style.display="none"; } }
function toggleRevealAnswers(){
  const code = prompt("Teacher code required to reveal/hide the answer key:");
  if (code === null) return;
  if (code !== TEACHER_CODE){ alert("Incorrect teacher code. Answer key was not changed."); return; }
  answersRevealed = !answersRevealed;
  const btn=document.getElementById("revealBtn");
  if (answersRevealed){ showAnswerKeys(); if (btn) btn.textContent="Hide Answers (Teacher)"; }
  else { hideAnswerKeys(); if (btn) btn.textContent="Reveal Answers (Teacher)"; }
}

function score(){
  const nameInput = document.getElementById("studentName");
  const name = (nameInput ? nameInput.value.trim() : "");
  // Validate required name BEFORE locking submission
  if (!name){
    alert("Please enter your Student Name before submitting.");
    if (nameInput) nameInput.focus();
    return;
  }
  if (hasSubmitted) return;
  const ok = confirm("Submit now? You can only submit once.");
  if (!ok) return;
  hasSubmitted = true;
  const sb = document.getElementById("scoreBtn");
  if (sb) { sb.disabled = true; sb.textContent = "Submitted"; }
  lockAllInputs();
clearHighlights();

  let mcPts=0, saPts=0;

  for (let n=1;n<=30;n++){ 
    const ans = getMcAnswer(n);
    if (!ans) continue;
    if (ans === MC_KEY[n]){ mcPts += 1; markQuestion(n,"correct"); }
    else markQuestion(n,"incorrect");
  }

  for (let n=31;n<=40;n++){
    const raw = getSaAnswer(n);
    if (!raw.trim()) continue;

    const userVal = parseNumericValue(raw);
    const accList = SA_ACCEPT[n] || [];
    let correctVal = NaN;
    for (const item of accList){ const v=parseNumericValue(item); if (isFinite(v)){ correctVal=v; break; } }
    if (nearlyEqual(userVal, correctVal)){ saPts += 2; markQuestion(n,"correct"); }
    else markQuestion(n,"incorrect");
  }

  const total = mcPts + saPts;
  const pct = Math.round((total/50)*1000)/10;

  document.getElementById("resultsBox").style.display="block";
  document.getElementById("rName").textContent = name;
  document.getElementById("rTotal").textContent = `${total} / 50`;
  document.getElementById("rPct").textContent = `${pct}%`;
  document.getElementById("rMC").textContent = `${mcPts} / 30`;
  document.getElementById("rSA").textContent = `${saPts} / 20`;
  document.getElementById("resultsTitle").textContent = "Results (Grade 8)";

  const timestamp = formatLocalTimestamp();
  const rows = [];

  for (let n=1; n<=30; n++){ 
    const q=MC_QUESTIONS.find(x=>x.n===n) || {};
    const student=getMcAnswer(n);
    const correct=MC_KEY[n] || "";
    const isCorrect = !!student && student===correct;
    rows.push({q:n,type:"MC",prompt:q.t||"",student:student||"",correctAnswer:correct,points:isCorrect?1:0,maxPoints:1,isCorrect});
  }

  for (let n=31; n<=40; n++){ 
    const q=SA_QUESTIONS.find(x=>x.n===n) || {};
    const studentRaw=getSaAnswer(n);
    const userVal=parseNumericValue(studentRaw);
    const accList=SA_ACCEPT[n] || [];
    let correctVal=NaN;
    let correctText="";
    for (const item of accList){ const v=parseNumericValue(item); if (isFinite(v)){ correctVal=v; correctText=item; break; } }
    const isCorrect = (studentRaw.trim() !== "") && nearlyEqual(userVal, correctVal);
    rows.push({
      q:n,type:"SA",prompt:q.t||"",student:studentRaw||"",
      correctAnswer:correctText,
      points:isCorrect?2:0,maxPoints:2,isCorrect
    });
  }

  const payload = {studentName:name,timestamp,mcPts,saPts,total,pct:pct+"%",maxScore:50,maxMc:30,maxSa:20,rows};
  const csvText = buildResultsCSV(payload);
  const safeName = name.replace(/[^a-z0-9]+/gi,"_").replace(/^_+|_+$/g,"");
  const filename = `KofC_Grade8_${safeName || "Student"}_${timestamp.replace(/[: ]/g,"-")}.csv`;
  downloadCSV(filename, csvText);

  document.getElementById("resultsBox").scrollIntoView({behavior:"smooth", block:"start"});
}

function teacherReset(){
  const code = prompt("Teacher reset code required to clear all answers/results:");
  if (code === null) return;
  if (code !== TEACHER_CODE){
    alert("Incorrect reset code. Answers were not cleared.");
    return;
  }
  if (!confirm("Clear all answers and results?")) return;
  document.getElementById("testForm").reset();
  // Student name is outside the form, so clear it explicitly
  const nameInput = document.getElementById("studentName");
  if (nameInput) nameInput.value = "";
  document.getElementById("resultsBox").style.display="none";
  clearHighlights();
  hasSubmitted = false;
  unlockAllInputs();
  const sb = document.getElementById("scoreBtn");
  if (sb){ sb.disabled = false; sb.textContent = "Submit & Score"; }
  if (answersRevealed) showAnswerKeys();
}

document.getElementById("scoreBtn").addEventListener("click", score);
document.getElementById("resetBtn").addEventListener("click", teacherReset);
document.getElementById("revealBtn").addEventListener("click", toggleRevealAnswers);

render();
</script>
</body>
</html>
