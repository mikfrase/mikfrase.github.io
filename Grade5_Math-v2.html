<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Knights of Columbus – 2026 Knowledge Contest – Math Grade 5 (Auto-Scored)</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --kc-red:#b5121b;
      --kc-blue:#003a70;
      --ok:#e7f8ef;
      --bad:#fde8e8;
      --border:#e5e7eb;
      --shadow:0 8px 24px rgba(0,0,0,.08);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background:var(--bg);
      color:var(--ink);
      line-height:1.35;
    }
    .wrap{max-width:980px;margin:24px auto;padding:0 14px}
    header{
      background:linear-gradient(135deg,var(--kc-blue),#0b5aa1);
      color:white;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px 18px 16px;
    }
    .title{display:flex;flex-wrap:wrap;gap:10px;align-items:baseline;justify-content:space-between}
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .badge{background:rgba(255,255,255,.16);border:1px solid rgba(255,255,255,.22);padding:6px 10px;border-radius:999px;font-size:12px}
    .sub{margin:8px 0 0;font-size:13px;color:rgba(255,255,255,.92)}
    .card{background:var(--card);margin:14px 0;border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 6px 18px rgba(0,0,0,.06);padding:16px;}
    .instructions{display:grid;gap:8px;font-size:14px;color:var(--ink);}
    .instructions ul{margin:6px 0 0 18px}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-top:12px}
    label{font-weight:600}
    input[type="text"]{width:min(420px,100%);padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;outline:none;}
    input[type="text"]:focus{border-color:#93c5fd; box-shadow:0 0 0 3px rgba(147,197,253,.35)}
    .section-title{margin:0 0 10px;font-size:16px;color:var(--kc-blue);display:flex;align-items:center;gap:10px}
    .section-title .pill{font-size:12px;background:#eef2ff;border:1px solid #dbeafe;padding:4px 10px;border-radius:999px;color:#1e40af}
    .q{border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 0;background:#fff;}
    .q.correct{background:var(--ok); border-color:#a7f3d0}
    .q.incorrect{background:var(--bad); border-color:#fecaca}
    .qhead{display:flex;gap:10px;align-items:flex-start}
    .qnum{min-width:34px;height:34px;border-radius:10px;display:grid;place-items:center;background:#f3f4f6;border:1px solid var(--border);font-weight:700;}
    .qtext{flex:1}
    .choices{margin-top:10px;display:grid;gap:8px}
    .choice{display:flex;gap:10px;align-items:flex-start;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fbfbfc;}
    .choice input{margin-top:3px}
    .sa{margin-top:10px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .sa input[type="text"]{width:min(320px,100%)}
    .actions{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    button{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;font-size:14px;}
    .primary{background:var(--kc-red);color:white}
    .primary:hover{filter:brightness(.95)}
    .ghost{background:#f3f4f6;color:#111827;border:1px solid var(--border)}
    .ghost:hover{background:#eef2f7}
    .note{color:var(--muted);font-size:12px}
    .results{border:1px solid var(--border);border-radius:14px;padding:14px;background:#f8fafc;display:none;}
    .results h2{margin:0 0 8px;font-size:16px;color:#111827}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:10px}
    .stat{background:white;border:1px solid var(--border);border-radius:12px;padding:10px;}
    .stat .k{font-size:12px;color:var(--muted)}
    .stat .v{font-size:18px;font-weight:800;margin-top:2px}
    .print-hint{margin-top:10px}
    @media print{
      body{background:white}
      header{box-shadow:none}
      .card{box-shadow:none}
      button,.note{display:none!important}
      .results{display:block!important}
    }
  
    .answer-key{
      margin-top:10px;
      display:none;
      font-size:13px;
      color:#111827;
    }
    .answer-key .tag{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#ffffff;
      font-weight:700;
      margin-right:8px;
    }
    .answer-key .val{
      color:#111827;
      font-weight:700;
    }
    .answer-key .muted{
      color:var(--muted);
      font-weight:600;
    }

    .req{color:var(--kc-red);font-weight:900;margin-left:2px}
    .sr-only{
      position:absolute!important;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);
      white-space:nowrap;border:0;
    }

</style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>Knights of Columbus – 2026 Knowledge Contest – Mathematics (Grade 5)</h1>
      <div class="badge">Online • Auto-Scored • Printable</div>
    </div>
    <div class="sub">
      Multiple Choice 1–30 (1 point each) • Short Answer 31–40 (2 points each)
    </div>
  </header>

  <div class="card">
    <div class="instructions">
      <div><strong>Instructions</strong></div>
      <ul>
        <li><strong>Time:</strong> 30 minutes. Answer as many of the 40 questions as you can.</li>
        <li><strong>Tools:</strong> Use pencil and scratch paper. No calculators, smartphones, or smart watches.</li>
        <li><strong>Remember:</strong> This is a contest—do your best!</li>
      </ul>

      <div class="row">
        <label for="studentName">Student Name <span class="req" aria-hidden="true">*</span> <span class="sr-only">(required)</span>:</label>
        <input id="studentName" type="text" placeholder="Type your name here…" autocomplete="name" />
      </div>
      <div class="note">Tip: After scoring, you can print this page. Your name and score appear in the results box.</div>
    </div>
  </div>

  <form id="testForm" class="card" onsubmit="return false;">
    <div class="section-title">
      Multiple Choice <span class="pill">Questions 1–30</span>
    </div>
    <div id="mc"></div>

    <div class="section-title" style="margin-top:18px;">
      Short Answer <span class="pill">Questions 31–40</span>
    </div>
    <div id="sa"></div>

    <div class="actions" style="margin-top:16px;">
      <button class="primary" id="scoreBtn" type="button">Submit &amp; Score</button>
      <button class="ghost" id="resetBtn" type="button">Reset (Teacher)</button>
      <button class="ghost" id="revealBtn" type="button">Reveal Answers (Teacher)</button>
      <span class="note">Only answered questions are highlighted ✅/❌ after scoring.</span>
    </div>

    <div class="results" id="resultsBox" aria-live="polite">
      <h2 id="resultsTitle">Results</h2>
      <div class="grid">
        <div class="stat"><div class="k">Student</div><div class="v" id="rName">—</div></div>
        <div class="stat"><div class="k">Total Score</div><div class="v" id="rTotal">—</div></div>
        <div class="stat"><div class="k">Percent</div><div class="v" id="rPct">—</div></div>
        <div class="stat"><div class="k">MC (1–30)</div><div class="v" id="rMC">—</div></div>
        <div class="stat"><div class="k">Short Answer (31–40)</div><div class="v" id="rSA">—</div></div>
      </div>
      <div class="print-hint note">Printing tip: Use your browser’s Print command. This page is print-friendly.</div>
    </div>
  </form>
</div>

<script>
// Teacher lock code (change this value if you want a different reset code)
const TEACHER_CODE = "KOC2026";

const MC_QUESTIONS = [
  {n:1, t:"A coin purse contained 5 quarters, 6 dimes, 7 nickels and 12 pennies. What is the total value of these coins?", a:["$2.32","$1.32","$2.22","not given"]},
  {n:2, t:"The correct numeral for four hundred six million, ninety-seven thousand, ten is:", a:["460,970,010","406,097,010","406,907,010","not given"]},
  {n:3, t:"2960 ÷ 4 = ?", a:["704","74","740","not given"]},
  {n:4, t:"Mary started her homework at 3:45 P.M. She studied for an hour and 25 minutes. What time was it when she finished?", a:["6:10 P.M.","4:10 P.M.","5:10 P.M.","not given"]},
  {n:5, t:"84 + 361 + 9 + 38 = ?", a:["492","392","482","not given"]},
  {n:6, t:"What fraction of a checkerboard is black?", a:["1/5","1/3","1/4","not given"]},
  {n:7, t:"Which numeral equals four ten-thousands, no thousands, eight hundreds, nine tens, seven ones?", a:["48,097","40,897","40,987","not given"]},
  {n:8, t:"896 × 74 = ?", a:["66,284","65,204","66,304","not given"]},
  {n:9, t:"What is the perimeter of a postcard that is 4 inches long and 6 inches wide?", a:["24 in","20 in","10 in","not given"]},
  {n:10, t:"$50.00 − $27.98 = ?", a:["$23.12","$22.02","$23.02","not given"]},
  {n:11, t:"70,053 − 46,341 = ?", a:["23,612","23,712","24,712","not given"]},
  {n:12, t:"A football field is 100 yards long. What is its length in feet?", a:["3000","300","30,000","not given"]},
  {n:13, t:"Which digits are in the thousands period in 467,306,097,503?", a:["097","306","503","467"]},
  {n:14, t:"743 + 4109 + 562 + 1053 = ?", a:["6476","6674","6647","not given"]},
  {n:15, t:"364 × 90 = ?", a:["32,760","32,460","27,760","not given"]},
  {n:16, t:"Four pounds + 12 ounces = ? ounces.", a:["60","64","68","not given"]},
  {n:17, t:"Three and seven eighths is equal to:", a:["24/8","3 × 7/8","3 + 7/8","not given"]},
  {n:18, t:"What is the length of a rectangle whose width is 12 inches and whose perimeter is 5 feet?", a:["24 in","60 in","18 in","not given"]},
  {n:19, t:"614 ÷ 20 = ?", a:["300 R 14","3 R 14","30 R 14","not given"]},
  {n:20, t:"1 3/4 + 5/8 = ?", a:["2 3/8","2","2 5/8","3 3/8"]},
  {n:21, t:"If glass costs $1.02 per square foot, what would be the cost of a pane of glass 8 feet long and 7 feet wide?", a:["$57.12","$30.60","$15.30","not given"]},
  {n:22, t:"9827 ÷ 16 = ?", a:["604 R 3","614 R 16","614 R 3","not given"]},
  {n:23, t:"7 1/3 − 2 5/9 = ?", a:["5 2/9","4 7/9","5 7/9","not given"]},
  {n:24, t:"Which of these fractions is the smallest?", a:["1/4","5/16","9/32","3/8"]},
  {n:25, t:"Five yards + two feet = ? feet.", a:["17","7","10","not given"]},
  {n:26, t:"Mr. Ryan stopped for gas 3 times on a recent trip. He listed 11.6, 12.3, 8.7 gallons on his expense account. How many gallons did he buy in all?", a:["31.6","22.6","32.6","not given"]},
  {n:27, t:"Subtract 19.38 from 37.", a:["17.72","18.38","18.62","not given"]},
  {n:28, t:"Four gallons + 3 quarts = ? quarts.", a:["19","38","7","not given"]},
  {n:29, t:"What is the sum of 37.25 + 193.8 + 12.97?", a:["69.6","244.02","522.08","not given"]},
  {n:30, t:"What is the formula for the area of a rectangle?", a:["A = 2(l × w)","A = 2(l + w)","A = l × w","not given"]}
];

// Official MC answer key (A/B/C/D)
const MC_KEY = {
  1:"A",
  2:"B",
  3:"C",
  4:"C",
  5:"A",
  6:"D",
  7:"B",
  8:"C",
  9:"B",
  10:"B",
  11:"B",
  12:"B",
  13:"A",
  14:"D",
  15:"A",
  16:"D",
  17:"C",
  18:"C",
  19:"C",
  20:"A",
  21:"A",
  22:"C",
  23:"B",
  24:"A",
  25:"A",
  26:"C",
  27:"D",
  28:"A",
  29:"B",
  30:"C"
};

const SA_QUESTIONS = [
  {n:31, t:"A hummingbird’s wings can beat as many as 4500 times per minute. This is an average of how many times per second?"},
  {n:32, t:"A nuclear submarine traveled 41,496 miles in 84 days. What was its average daily mileage?"},
  {n:33, t:"Liz filled a 4 quart pitcher with lemonade from a 6 gallon container. How many quarts were left for refills?"},
  {n:34, t:"A rectangle is 5 yards long and 8 1/2 feet wide. What is its area in square feet?"},
  {n:35, t:"Work began on the Panama Canal in 1881. It was opened in 1917. How many years did it take to build the canal?"},
  {n:36, t:"Mr. Torres earned $682.50 last week. For the first 40 hours he received $12.00 per hour. How much did he earn in overtime?"},
  {n:37, t:"A sky diver jumped at a height of 2 miles. How many feet did he fall?"},
  {n:38, t:"In a three-person election 38,947 votes were cast. Smith received 9087 votes and Jones received 8406 votes. How many votes did the winner receive?"},
  {n:39, t:"A living room is 21 feet long. It took 42 square yards of carpeting to cover the floor. What is the width of the room in feet?"},
  {n:40, t:"Find the perimeter of a rectangle whose sides measure 3 1/2 inches and 9 1/4 inches."}
];

// Acceptable answers from the official key (units/words allowed; we grade by numeric value only)
const SA_ACCEPT = {
  31: ["75"],
  31: ["75"],
  32: ["494","494mi","494mile","494miles"],
  33: ["20","20qt","20quart","20quarts"],
  34: ["127.5","1275/10","127.5sqft","127.5ft2","127.5squarefeet"],
  35: ["36","36yr","36year","36years"],
  36: ["202.5","20250/100","202.50"],
  37: ["10560","10560ft","10560feet"],
  38: ["21454"],
  39: ["18","18ft","18feet"],
  40: ["25.5","25 1/2","25.5in","25.5inch","25.5inches"]
};

/* Parse a numeric value from a student response, ignoring letters/units.
   Supports:
   - integers: 75
   - decimals: 127.5
   - fractions: 1/2
   - mixed numbers: 25 1/2 (also 25-1/2)
*/
function parseNumericValue(input){
  if (input == null) return NaN;
  let s = String(input).toLowerCase();

  // Keep digits, minus, dot, slash, and spaces (for mixed numbers)
  s = s.replace(/[^0-9\-\.\/\s]/g, " ");
  s = s.replace(/\s+/g, " ").trim();
  if (!s) return NaN;

  // Mixed number like "25 1/2" or "25-1/2"
  let m = s.match(/^(-?\d+)\s+(-?\d+)\s*\/\s*(\d+)$/);
  if (m){
    const whole = parseInt(m[1],10);
    const num = parseInt(m[2],10);
    const den = parseInt(m[3],10);
    if (den === 0) return NaN;
    const sign = whole < 0 ? -1 : 1;
    return whole + sign*(Math.abs(num)/den);
  }

  // Fraction like "1/2"
  m = s.match(/^(-?\d+)\s*\/\s*(\d+)$/);
  if (m){
    const num = parseInt(m[1],10);
    const den = parseInt(m[2],10);
    if (den === 0) return NaN;
    return num/den;
  }

  // Decimal or integer (take first token that looks like a number)
  m = s.match(/-?\d+(?:\.\d+)?/);
  if (m) return parseFloat(m[0]);

  return NaN;
}

function nearlyEqual(a,b){
  if (!isFinite(a) || !isFinite(b)) return false;
  const eps = 1e-9;
  return Math.abs(a-b) <= eps;
}

function el(tag, attrs={}, children=[]){
  const e = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)){
    if (k === "class") e.className = v;
    else if (k === "html") e.innerHTML = v;
    else e.setAttribute(k, v);
  }
  for (const c of children){
    if (typeof c === "string") e.appendChild(document.createTextNode(c));
    else e.appendChild(c);
  }
  return e;
}

function render(){
  const mc = document.getElementById("mc");
  MC_QUESTIONS.forEach(q=>{
    const box = el("div",{class:"q", id:`q${q.n}`},[
      el("div",{class:"qhead"},[
        el("div",{class:"qnum"},[String(q.n)]),
        el("div",{class:"qtext"},[
          el("div",{html:`<strong>${q.t}</strong>`})
        ])
      ])
    ]);

    const choices = el("div",{class:"choices"});
    const letters = ["A","B","C","D"];
    q.a.forEach((txt,i)=>{
      const id = `q${q.n}_${letters[i]}`;
      const choice = el("label",{class:"choice", for:id},[
        el("input",{type:"radio", name:`q${q.n}`, id, value:letters[i]}),
        el("span",{html:`<strong>${letters[i]}.</strong> ${txt}`})
      ]);
      choices.appendChild(choice);
    });

    box.appendChild(choices);

    const ak = el("div",{class:"answer-key", id:`ak${q.n}`},[
      el("span",{class:"tag"},["Answer"]),
      el("span",{class:"val", id:`akv${q.n}`},["—"]),
      el("span",{class:"muted"},["(teacher)"])
    ]);
    box.appendChild(ak);

    mc.appendChild(box);
  });

  const sa = document.getElementById("sa");
  SA_QUESTIONS.forEach(q=>{
    const box = el("div",{class:"q", id:`q${q.n}`},[
      el("div",{class:"qhead"},[
        el("div",{class:"qnum"},[String(q.n)]),
        el("div",{class:"qtext"},[
          el("div",{html:`<strong>${q.t}</strong>`})
        ])
      ]),
      el("div",{class:"sa"},[
        el("label",{for:`sa${q.n}`},["Answer:"]),
        el("input",{type:"text", id:`sa${q.n}`, placeholder:"Type your answer (numbers only; units OK)…"})
      ])
    ]);
    const ak = el("div",{class:"answer-key", id:`ak${q.n}`},[
      el("span",{class:"tag"},["Answer"]),
      el("span",{class:"val", id:`akv${q.n}`},["—"]),
      el("span",{class:"muted"},["(teacher)"])
    ]);
    box.appendChild(ak);
    sa.appendChild(box);
  });
}

function clearHighlights(){
  document.querySelectorAll(".q.correct,.q.incorrect").forEach(d=>{
    d.classList.remove("correct","incorrect");
  });
}

function markQuestion(n, status){
  const box = document.getElementById(`q${n}`);
  if (!box) return;
  box.classList.remove("correct","incorrect");
  if (status === "correct") box.classList.add("correct");
  if (status === "incorrect") box.classList.add("incorrect");
}

function getMcAnswer(n){
  const checked = document.querySelector(`input[name="q${n}"]:checked`);
  return checked ? checked.value : "";
}
function getSaAnswer(n){
  const inp = document.getElementById(`sa${n}`);
  return inp ? inp.value : "";
}

let hasSubmitted = false;

function setLocked(isLocked){
  // Lock/unlock all student inputs after submit so answers cannot be changed.
  const nameInput = document.getElementById("studentName");
  if (nameInput) nameInput.disabled = !!isLocked;

  // All multiple-choice radios
  document.querySelectorAll('#testForm input[type="radio"]').forEach(inp=>{
    inp.disabled = !!isLocked;
  });

  // All short-answer text inputs
  document.querySelectorAll('#testForm input[type="text"]').forEach(inp=>{
    // Skip the studentName (already handled)
    if (inp.id === "studentName") return;
    inp.disabled = !!isLocked;
  });
}

function score(){
  const nameInput = document.getElementById("studentName");
  const name = (nameInput ? nameInput.value : "").trim();

  // Require student name BEFORE locking submission
  if (!name){
    alert("Please enter your Student Name before submitting.");
    if (nameInput) nameInput.focus();
    return;
  }

  // Prevent double-submit only after validation
  if (hasSubmitted) return;

  const ok = confirm("Submit now? You can only submit once.");
  if (!ok) return;

  hasSubmitted = true;

  const sb = document.getElementById("scoreBtn");
  if (sb){
    sb.disabled = true;
    sb.textContent = "Submitted";
  }

  // Lock all answers so they cannot be changed after submitting
  setLocked(true);

  clearHighlights();

  let mcPts=0, saPts=0;

  for (let n=1;n<=30;n++){ 
    const ans = getMcAnswer(n);
    if (!ans) continue;
    if (ans === MC_KEY[n]){ mcPts += 1; markQuestion(n,"correct"); }
    else markQuestion(n,"incorrect");
  }

  for (let n=31;n<=40;n++){
    const raw = getSaAnswer(n);
    if (!raw.trim()) continue;

    const userVal = parseNumericValue(raw);
    // Determine the correct numeric value from any acceptable key entry
    const accList = SA_ACCEPT[n] || [];
    let correctVal = NaN;
    for (const item of accList){
      const v = parseNumericValue(item);
      if (isFinite(v)) { correctVal = v; break; }
    }
    // Fallback: if key list is empty, mark incorrect
    if (isFinite(userVal) && isFinite(correctVal) && nearlyEqual(userVal, correctVal)){
      saPts += 2;
      markQuestion(n,"correct");
    } else {
      markQuestion(n,"incorrect");
    }
  }

  const total = mcPts + saPts;
  const pct = Math.round((total/50)*1000)/10;

  document.getElementById("resultsBox").style.display="block";
  document.getElementById("rName").textContent = name;
  document.getElementById("rTotal").textContent = `${total} / 50`;
  document.getElementById("rPct").textContent = `${pct}%`;
  document.getElementById("rMC").textContent = `${mcPts} / 30`;
  document.getElementById("rSA").textContent = `${saPts} / 20`;

  document.getElementById("resultsTitle").textContent = "Results (Grade 5)";
  
  // --- Export results to CSV (downloads locally) ---
  const timestamp = formatLocalTimestamp();
  const rows = [];

  // MC details
  for (let n=1; n<=30; n++){
    const prompt = (MC_QUESTIONS.find(x=>x.n===n) || {}).t || "";
    const student = getMcAnswer(n);
    const correct = MC_KEY[n] || "";
    const answered = !!student;
    const isCorrect = answered && student === correct;
    rows.push({
      q: n,
      type: "MC",
      prompt,
      student: student || "",
      correctAnswer: correct,
      points: isCorrect ? 1 : 0,
      maxPoints: 1,
      isCorrect
    });
  }

  // SA details
  for (let n=31; n<=40; n++){
    const prompt = (SA_QUESTIONS.find(x=>x.n===n) || {}).t || "";
    const studentRaw = getSaAnswer(n);
    const studentVal = isFinite(parseNumericValue(studentRaw)) ? parseNumericValue(studentRaw) : "";
    // Determine correct numeric from acceptable list
    const accList = SA_ACCEPT[n] || [];
    let correctVal = "";
    for (const item of accList){
      const v = parseNumericValue(item);
      if (isFinite(v)) { correctVal = v; break; }
    }
    const isCorrect = (studentRaw.trim() !== "") && isFinite(studentVal) && isFinite(correctVal) && nearlyEqual(studentVal, correctVal);
    rows.push({
      q: n,
      type: "SA",
      prompt,
      student: studentRaw || "",
      correctAnswer: (correctVal === "" ? "" : (Number.isInteger(correctVal) ? String(correctVal) : String(correctVal))),
      points: isCorrect ? 2 : 0,
      maxPoints: 2,
      isCorrect
    });
  }

  const payload = {
    studentName: name,
    timestamp,
    mcPts, saPts, total,
    pct: pct + "%",
    maxScore: 50,
    maxMc: 30,
    maxSa: 20,
    rows
  };

  const csvText = buildResultsCSV(payload);
  const safeName = name.replace(/[^a-z0-9]+/gi,"_").replace(/^_+|_+$/g,"");
  const filename = `KofC_Grade5_${safeName || "Student"}_${timestamp.replace(/[: ]/g,"-")}.csv`;
  downloadCSV(filename, csvText);

  document.getElementById("resultsBox").scrollIntoView({behavior:"smooth", block:"start"});
}


function csvEscape(value){
  const s = (value === null || value === undefined) ? "" : String(value);
  // Escape quotes by doubling them; wrap field in quotes if it contains comma, quote, or newline
  if (/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
  return s;
}

function formatLocalTimestamp(){
  const d = new Date();
  const pad = (n)=> String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

function buildResultsCSV(payload){
  // payload: { studentName, timestamp, mcPts, saPts, total, pct, rows: [{q,type,prompt,student,correct,points,maxPoints}] }
  const header = [
    "Student Name","Timestamp","Total Score","Max Score","Percent","MC Score","MC Max","Short Answer Score","Short Answer Max"
  ];
  const summary = [
    payload.studentName, payload.timestamp,
    payload.total, payload.maxScore, payload.pct,
    payload.mcPts, payload.maxMc, payload.saPts, payload.maxSa
  ];

  const lines = [];
  lines.push(header.map(csvEscape).join(","));
  lines.push(summary.map(csvEscape).join(","));
  lines.push(""); // blank line
  lines.push(["Question","Type","Prompt","Student Answer","Correct Answer","Points Earned","Max Points","Correct?"].map(csvEscape).join(","));

  for (const r of payload.rows){
    lines.push([
      r.q, r.type, r.prompt, r.student, r.correctAnswer, r.points, r.maxPoints, r.isCorrect ? "YES" : "NO"
    ].map(csvEscape).join(","));
  }
  return lines.join("\n");
}

function downloadCSV(filename, csvText){
  const blob = new Blob([csvText], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

function teacherReset(){
  const code = prompt("Teacher reset code required to clear all answers/results:");
  if (code === null) return;
  if (code !== TEACHER_CODE){
    alert("Incorrect reset code. Answers were not cleared.");
    return;
  }
  if (!confirm("Clear all answers and results?")) return;
  document.getElementById("testForm").reset();
  // Student name input sits outside the <form>, so clear it explicitly
  const sn = document.getElementById("studentName");
  if (sn) sn.value = "";
  document.getElementById("resultsBox").style.display="none";
  clearHighlights();

  // Unlock for a new student/test attempt
  hasSubmitted = false;
  setLocked(false);
  const sb = document.getElementById('scoreBtn');
  if (sb){ sb.disabled = false; sb.textContent = 'Submit & Score'; }
  if (answersRevealed) showAnswerKeys();
}


let answersRevealed = false;


function showAnswerKeys(){
  // Multiple Choice answers (1–30)
  for (let n = 1; n <= 30; n++) {
    const v = document.getElementById(`akv${n}`);
    const c = document.getElementById(`ak${n}`);
    if (v) v.textContent = MC_KEY[n] || "—";
    if (c) c.style.display = "block";
  }

  // Short Answer numeric answers (31–40)
  for (let n = 31; n <= 40; n++) {
    const v = document.getElementById(`akv${n}`);
    const c = document.getElementById(`ak${n}`);
    if (v) {
      let correctVal = "—";
      const accList = SA_ACCEPT[n] || [];
      for (const item of accList) {
        const num = parseNumericValue(item);
        if (isFinite(num)) {
          correctVal = Number.isInteger(num) ? String(num) : String(num);
          break;
        }
      }
      v.textContent = correctVal;
    }
    if (c) c.style.display = "block";
  }
}


function hideAnswerKeys(){
  for (let n=1; n<=40; n++){
    const c = document.getElementById(`ak${n}`);
    if (c) c.style.display = "none";
  }
}

function toggleRevealAnswers(){
  const code = prompt("Teacher code required to reveal/hide the answer key:");
  if (code === null) return;
  if (code !== TEACHER_CODE){
    alert("Incorrect teacher code. Answer key was not changed.");
    return;
  }
  answersRevealed = !answersRevealed;
  const btn = document.getElementById("revealBtn");
  if (answersRevealed){
    showAnswerKeys();
    if (btn) btn.textContent = "Hide Answers (Teacher)";
  } else {
    hideAnswerKeys();
    if (btn) btn.textContent = "Reveal Answers (Teacher)";
  }
}

const scoreBtn = document.getElementById("scoreBtn");
if (scoreBtn) scoreBtn.addEventListener("click", score);

const resetBtn = document.getElementById("resetBtn");
if (resetBtn) resetBtn.addEventListener("click", teacherReset);

const revealBtn = document.getElementById("revealBtn");
if (revealBtn) revealBtn.addEventListener("click", toggleRevealAnswers);

render();
</script>
</body>
</html>
